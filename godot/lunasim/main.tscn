[gd_scene load_steps=11 format=3 uid="uid://bxmnthetrtkso"]

[sub_resource type="GDScript" id="GDScript_x4vum"]
script/source = "extends StaticBody3D

const WIDTH := 4.0
const LENGTH := 8.0
const WIDTH_CELLS := 30
const LENGTH_CELLS := 60
const MAX_NOISE_HEIGHT := 0.2
const MAX_HILL_HEIGHT := 0.5


func _ready() -> void:
	var collision_shape: CollisionShape3D = $CollisionShape3D
	var width_scale := WIDTH / (WIDTH_CELLS - 1)
	var length_scale := LENGTH / (LENGTH_CELLS - 1)
	collision_shape.scale.x = width_scale
	collision_shape.scale.z = length_scale
	collision_shape.position.x = - WIDTH / 2
	collision_shape.position.z = - LENGTH / 2
	var heightmap: HeightMapShape3D = collision_shape.shape
	heightmap.map_width = WIDTH_CELLS
	heightmap.map_depth = LENGTH_CELLS
	
	var noise := FastNoiseLite.new()
	noise.seed = randi()
	noise.frequency = 0.3
	print(\"Using noise seed: %s\" % noise.seed)
	
	var hills := FastNoiseLite.new()
	hills.seed = randi()
	hills.frequency = 0.05
	print(\"Using hills seed: %s\" % hills.seed)
	
	for x in range(WIDTH_CELLS):
		for y in range(LENGTH_CELLS):
			heightmap.map_data[x + y * WIDTH_CELLS] = remap(noise.get_noise_2d(x, y), -1, 1, 0, MAX_NOISE_HEIGHT) + remap(hills.get_noise_2d(x, y), -1, 1, 0, MAX_HILL_HEIGHT)
	
	collision_shape.position.y = - heightmap.get_min_height()
	
	var mesh_instance: MeshInstance3D = $MeshInstance3D
	var mesh: ImmediateMesh = mesh_instance.mesh
	mesh.surface_begin(Mesh.PRIMITIVE_TRIANGLE_STRIP)
	
	for y in range(LENGTH_CELLS - 1):
		for x in range(WIDTH_CELLS):
			if y % 2 == 0:
				mesh.surface_set_normal(Vector3.DOWN)
			else:
				mesh.surface_set_normal(Vector3.UP)
				x = WIDTH_CELLS - x - 1
			mesh.surface_add_vertex(Vector3(- x * width_scale, heightmap.map_data[(WIDTH_CELLS - x - 1) + (LENGTH_CELLS - y - 1) * WIDTH_CELLS], - y * length_scale))
			mesh.surface_add_vertex(Vector3(- x * width_scale, heightmap.map_data[(WIDTH_CELLS - x - 1) + (LENGTH_CELLS - y - 2) * WIDTH_CELLS], - (y + 1) * length_scale))
			
	#mesh.surface_add_vertex(Vector3((WIDTH_CELLS - 2) * width_scale, 0, LENGTH_CELLS * length_scale))
	mesh.surface_end()
	mesh_instance.position.y = collision_shape.position.y
"

[sub_resource type="HeightMapShape3D" id="HeightMapShape3D_s2y32"]

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_501rf"]
cull_mode = 2

[sub_resource type="ImmediateMesh" id="ImmediateMesh_np8a4"]

[sub_resource type="WorldBoundaryShape3D" id="WorldBoundaryShape3D_kxs4p"]

[sub_resource type="PlaneMesh" id="PlaneMesh_twbw0"]
size = Vector2(2, 8)

[sub_resource type="PlaneMesh" id="PlaneMesh_reayg"]
size = Vector2(2, 4)

[sub_resource type="PhysicalSkyMaterial" id="PhysicalSkyMaterial_e6mxc"]
energy_multiplier = 2.0

[sub_resource type="Sky" id="Sky_1xo37"]
sky_material = SubResource("PhysicalSkyMaterial_e6mxc")

[sub_resource type="Environment" id="Environment_4hw3w"]
background_mode = 2
sky = SubResource("Sky_1xo37")

[node name="Node3D" type="Node3D"]

[node name="Floor" type="StaticBody3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.5, 0, 0.5)
script = SubResource("GDScript_x4vum")

[node name="CollisionShape3D" type="CollisionShape3D" parent="Floor"]
shape = SubResource("HeightMapShape3D_s2y32")

[node name="MeshInstance3D" type="MeshInstance3D" parent="Floor"]
material_override = SubResource("StandardMaterial3D_501rf")
mesh = SubResource("ImmediateMesh_np8a4")

[node name="StaticBody3D" type="StaticBody3D" parent="."]

[node name="CollisionShape3D" type="CollisionShape3D" parent="StaticBody3D"]
transform = Transform3D(-4.37114e-08, 1, 0, -1, -4.37114e-08, 0, 0, 0, 1, -3.5, 0, 0)
shape = SubResource("WorldBoundaryShape3D_kxs4p")

[node name="MeshInstance3D" type="MeshInstance3D" parent="StaticBody3D/CollisionShape3D"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, -3.5)
mesh = SubResource("PlaneMesh_twbw0")

[node name="CollisionShape3D2" type="CollisionShape3D" parent="StaticBody3D"]
transform = Transform3D(1.91069e-15, -4.37114e-08, 1, -1, -4.37114e-08, 0, 4.37114e-08, -1, -4.37114e-08, 0, 0, 0.5)
shape = SubResource("WorldBoundaryShape3D_kxs4p")

[node name="MeshInstance3D" type="MeshInstance3D" parent="StaticBody3D/CollisionShape3D2"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, -1.5)
mesh = SubResource("PlaneMesh_reayg")

[node name="CollisionShape3D3" type="CollisionShape3D" parent="StaticBody3D"]
transform = Transform3D(-5.73206e-15, 1.31134e-07, -1, -1, -4.37114e-08, 0, -4.37114e-08, 1, 1.31134e-07, 0, 0, -7.5)
shape = SubResource("WorldBoundaryShape3D_kxs4p")

[node name="MeshInstance3D" type="MeshInstance3D" parent="StaticBody3D/CollisionShape3D3"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 1.5)
mesh = SubResource("PlaneMesh_reayg")

[node name="CollisionShape3D4" type="CollisionShape3D" parent="StaticBody3D"]
transform = Transform3D(4.37114e-08, -1, -8.74228e-08, -1, -4.37114e-08, 0, -3.82137e-15, 8.74228e-08, -1, 0.5, 0, 0)
shape = SubResource("WorldBoundaryShape3D_kxs4p")

[node name="MeshInstance3D" type="MeshInstance3D" parent="StaticBody3D/CollisionShape3D4"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -1, 0, 3.5)
mesh = SubResource("PlaneMesh_twbw0")

[node name="Robot" type="Node3D" parent="."]

[node name="OriginOnly" type="Node3D" parent="Robot"]
top_level = true

[node name="CameraPivot" type="Marker3D" parent="Robot/OriginOnly"]
transform = Transform3D(0.93343, -0.220396, -0.283078, 0.229795, 0.973239, 0, 0.275503, -0.0650499, 0.959097, 0, 0.5, 0)

[node name="Camera3D" type="Camera3D" parent="Robot/OriginOnly/CameraPivot"]
transform = Transform3D(-4.37114e-08, 0, 1, 0, 1, 0, -1, 0, -4.37114e-08, 3.46343, 0, 0)

[node name="RemoteTransform3D" type="RemoteTransform3D" parent="Robot"]
remote_path = NodePath("../OriginOnly")
update_rotation = false
update_scale = false

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource("Environment_4hw3w")

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="WorldEnvironment"]
transform = Transform3D(0.926909, 0.34775, -0.141101, 0.330633, -0.57883, 0.745411, 0.177544, -0.737581, -0.6515, -2.51144, 3.72433, 0)
